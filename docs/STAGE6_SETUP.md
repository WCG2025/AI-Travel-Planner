# ç¬¬å…­é˜¶æ®µï¼šåœ°å›¾ä¸å¯¼èˆªé›†æˆ ğŸ—ºï¸

## ğŸ¯ é˜¶æ®µç›®æ ‡

é›†æˆé«˜å¾·åœ°å›¾ JavaScript APIï¼Œåœ¨åœ°å›¾ä¸Šå¯è§†åŒ–å±•ç¤ºæ—…è¡Œè¡Œç¨‹ï¼Œæä¾›æ™¯ç‚¹ä½ç½®æ ‡è®°ã€è·¯çº¿è§„åˆ’å’Œå¯¼èˆªåŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. åœ°å›¾åŸºç¡€åŠŸèƒ½
- âœ… é«˜å¾·åœ°å›¾ API åŠ¨æ€åŠ è½½
- âœ… åœ°å›¾å®¹å™¨ç»„ä»¶å°è£…
- âœ… åœ°å›¾æ§ä»¶ï¼ˆç¼©æ”¾ã€æ¯”ä¾‹å°ºã€å·¥å…·æ ï¼‰
- âœ… åœ°å›¾æ ·å¼é…ç½®

### 2. åœ°ç†ç¼–ç æœåŠ¡
- âœ… åœ°å€ â†’ åæ ‡è½¬æ¢
- âœ… åæ ‡ â†’ åœ°å€è½¬æ¢
- âœ… æ‰¹é‡åœ°ç†ç¼–ç 
- âœ… å½“å‰ä½ç½®è·å–

### 3. è·¯çº¿è§„åˆ’
- âœ… é©¾è½¦è·¯çº¿è§„åˆ’
- âœ… æ­¥è¡Œè·¯çº¿è§„åˆ’
- âœ… éª‘è¡Œè·¯çº¿è§„åˆ’
- âœ… å…¬äº¤è·¯çº¿è§„åˆ’
- âœ… è·¯çº¿ä¿¡æ¯å±•ç¤ºï¼ˆè·ç¦»ã€æ—¶é—´ï¼‰

### 4. è¡Œç¨‹åœ°å›¾å¯è§†åŒ–
- âœ… æ™¯ç‚¹ä½ç½®æ ‡è®°
- âœ… æ´»åŠ¨ç±»å‹å›¾æ ‡ï¼ˆä¸åŒé¢œè‰²ï¼‰
- âœ… ç‚¹å‡»æ ‡è®°æ˜¾ç¤ºè¯¦æƒ…
- âœ… è‡ªåŠ¨è°ƒæ•´è§†é‡åŒ…å«æ‰€æœ‰æ™¯ç‚¹
- âœ… åœ°å›¾å›¾ä¾‹æ˜¾ç¤º

### 5. é›†æˆåˆ°è¡Œç¨‹è¯¦æƒ…
- âœ… æ–°å¢"åœ°å›¾å¯¼èˆª"æ ‡ç­¾é¡µ
- âœ… ä¸è¡Œç¨‹æ•°æ®è”åŠ¨
- âœ… å“åº”å¼åœ°å›¾å±•ç¤º

## ğŸ“‹ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ map.types.ts                    # åœ°å›¾ç±»å‹å®šä¹‰
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ map/
â”‚       â”œâ”€â”€ amap-loader.ts              # é«˜å¾·åœ°å›¾åŠ è½½å™¨
â”‚       â”œâ”€â”€ geocoding.ts                # åœ°ç†ç¼–ç æœåŠ¡
â”‚       â””â”€â”€ route-planning.ts           # è·¯çº¿è§„åˆ’æœåŠ¡
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ use-amap.ts                     # åœ°å›¾ React Hook
â””â”€â”€ components/
    â””â”€â”€ features/
        â””â”€â”€ map/
            â”œâ”€â”€ map-container.tsx       # åœ°å›¾å®¹å™¨ç»„ä»¶
            â””â”€â”€ itinerary-map.tsx       # è¡Œç¨‹åœ°å›¾ç»„ä»¶
```

## ğŸ”‘ ç¯å¢ƒé…ç½®

### 1. è·å–é«˜å¾·åœ°å›¾ API Key

å¦‚æœæ‚¨è¿˜æ²¡æœ‰ç”³è¯·ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. è®¿é—® [é«˜å¾·å¼€æ”¾å¹³å°](https://lbs.amap.com/)
2. æ³¨å†Œ/ç™»å½•è´¦å·
3. è¿›å…¥"åº”ç”¨ç®¡ç†" â†’ "æˆ‘çš„åº”ç”¨"
4. åˆ›å»ºæ–°åº”ç”¨
5. æ·»åŠ  Keyï¼š
   - æœåŠ¡å¹³å°ï¼š**Webç«¯ï¼ˆJS APIï¼‰**
   - Key åç§°ï¼š`AI-Travel-Planner-Web`
6. è®°å½• API Key

### 2. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ `.env.local` ä¸­æ·»åŠ ï¼š

```env
# é«˜å¾·åœ°å›¾
NEXT_PUBLIC_AMAP_KEY=your_amap_key_here
```

**æ³¨æ„**ï¼š
- é«˜å¾·åœ°å›¾ Key éœ€è¦ä½¿ç”¨ `NEXT_PUBLIC_` å‰ç¼€ï¼ˆå®¢æˆ·ç«¯è®¿é—®ï¼‰
- ä¸è¦å°† API Key æäº¤åˆ° Git ä»“åº“

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºç¡€åœ°å›¾å®¹å™¨

```tsx
import { MapContainer } from '@/components/features/map/map-container';

export function MyMap() {
  const handleMapReady = (map: any, amap: any) => {
    console.log('åœ°å›¾å·²å‡†å¤‡å¥½', map);
  };

  return (
    <MapContainer
      apiKey={process.env.NEXT_PUBLIC_AMAP_KEY || ''}
      config={{
        zoom: 12,
        center: { lng: 116.397428, lat: 39.90923 },
        showScale: true,
        showCompass: true,
      }}
      onMapReady={handleMapReady}
      className="w-full h-[500px]"
    />
  );
}
```

### 2. è¡Œç¨‹åœ°å›¾

```tsx
import { ItineraryMap } from '@/components/features/map/itinerary-map';

export function PlanMapView({ plan }) {
  return (
    <ItineraryMap
      plan={plan}
      apiKey={process.env.NEXT_PUBLIC_AMAP_KEY || ''}
      className="h-[600px]"
    />
  );
}
```

### 3. åœ°ç†ç¼–ç 

```tsx
import { geocode, reverseGeocode } from '@/lib/map/geocoding';

// åœ°å€ â†’ åæ ‡
const result = await geocode('åŒ—äº¬å¤©å®‰é—¨', 'åŒ—äº¬å¸‚');
console.log(result.coordinate); // { lng: 116.397428, lat: 39.90923 }

// åæ ‡ â†’ åœ°å€
const address = await reverseGeocode({ lng: 116.397428, lat: 39.90923 });
console.log(address.address.formattedAddress); // "åŒ—äº¬å¸‚ä¸œåŸåŒº..."
```

### 4. è·¯çº¿è§„åˆ’

```tsx
import { planRoute, formatDistance, formatDuration } from '@/lib/map/route-planning';

const route = await planRoute({
  origin: { lng: 116.397428, lat: 39.90923 },
  destination: { lng: 116.481488, lat: 39.990464 },
  mode: 'walking',
});

console.log(formatDistance(route.distance)); // "5.2å…¬é‡Œ"
console.log(formatDuration(route.duration)); // "1å°æ—¶5åˆ†é’Ÿ"
```

## ğŸ¨ åœ°å›¾æ ‡è®°é¢œè‰²

ä¸åŒæ´»åŠ¨ç±»å‹ä½¿ç”¨ä¸åŒé¢œè‰²çš„æ ‡è®°ï¼š

| æ´»åŠ¨ç±»å‹ | é¢œè‰² | è¯´æ˜ |
|---------|------|------|
| ğŸ›ï¸ æ™¯ç‚¹ | <span style="color: #FF5722">çº¢è‰²</span> | æ—…æ¸¸æ™¯ç‚¹ã€åèƒœå¤è¿¹ |
| ğŸ½ï¸ ç”¨é¤ | <span style="color: #FF9800">æ©™è‰²</span> | é¤å…ã€ç¾é£Ÿ |
| ğŸ¨ ä½å®¿ | <span style="color: #2196F3">è“è‰²</span> | é…’åº—ã€æ°‘å®¿ |
| ğŸš— äº¤é€š | <span style="color: #9C27B0">ç´«è‰²</span> | äº¤é€šæ¢çº½ |
| ğŸ›ï¸ è´­ç‰© | <span style="color: #4CAF50">ç»¿è‰²</span> | å•†åœºã€å•†åº— |
| ğŸ­ å¨±ä¹ | <span style="color: #E91E63">ç²‰è‰²</span> | å¨±ä¹åœºæ‰€ |
| ğŸ“ å…¶ä»– | <span style="color: #757575">ç°è‰²</span> | å…¶ä»–æ´»åŠ¨ |

## ğŸ“Š æŠ€æœ¯æ¶æ„

### 1. åœ°å›¾åŠ è½½æµç¨‹

```
ç”¨æˆ·è®¿é—®
  â†“
æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
  â†“ (æœªåŠ è½½)
åŠ¨æ€åŠ è½½ AMap JS API
  â†“
åˆå§‹åŒ–åœ°å›¾å®ä¾‹
  â†“
åˆ›å»ºåœ°å›¾æ§ä»¶
  â†“
åœ°å›¾å°±ç»ª
```

### 2. è¡Œç¨‹åœ°å›¾æ¸²æŸ“æµç¨‹

```
è·å–è¡Œç¨‹æ•°æ®
  â†“
æå–æ™¯ç‚¹åœ°å€
  â†“
æ‰¹é‡åœ°ç†ç¼–ç  (åœ°å€ â†’ åæ ‡)
  â†“
åˆ›å»ºåœ°å›¾æ ‡è®°
  â†“
è°ƒæ•´è§†é‡åŒ…å«æ‰€æœ‰æ ‡è®°
  â†“
è§„åˆ’è·¯çº¿ (å‰ä¸¤ä¸ªæ™¯ç‚¹)
  â†“
ç»˜åˆ¶è·¯çº¿
```

### 3. æ•°æ®æµ

```
TravelPlan â†’ Activities â†’ Addresses
                            â†“
                    Geocoding API
                            â†“
                       Coordinates
                            â†“
                     Map Markers
                            â†“
                   User Interaction
```

## ğŸ”§ API å‚è€ƒ

### MapContainer Props

| å±æ€§ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|-----|------|------|------|
| `apiKey` | string | âœ… | é«˜å¾·åœ°å›¾ API Key |
| `config` | MapConfig | âŒ | åœ°å›¾é…ç½® |
| `onMapReady` | function | âŒ | åœ°å›¾å‡†å¤‡å›è°ƒ |
| `className` | string | âŒ | CSS ç±»å |

### ItineraryMap Props

| å±æ€§ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|-----|------|------|------|
| `plan` | TravelPlan | âœ… | æ—…è¡Œè®¡åˆ’æ•°æ® |
| `apiKey` | string | âœ… | é«˜å¾·åœ°å›¾ API Key |
| `className` | string | âŒ | CSS ç±»å |

### åœ°ç†ç¼–ç å‡½æ•°

```typescript
// åœ°å€ â†’ åæ ‡
geocode(address: string, city?: string): Promise<GeocodingResult>

// åæ ‡ â†’ åœ°å€
reverseGeocode(coordinate: Coordinate): Promise<GeocodingResult>

// æ‰¹é‡åœ°ç†ç¼–ç 
batchGeocode(addresses: string[], city?: string): Promise<(GeocodingResult | null)[]>

// è·å–å½“å‰ä½ç½®
getCurrentPosition(): Promise<Coordinate>
```

### è·¯çº¿è§„åˆ’å‡½æ•°

```typescript
// ç»Ÿä¸€è·¯çº¿è§„åˆ’
planRoute(request: RoutePlanRequest): Promise<Route>

// é©¾è½¦è·¯çº¿
planDrivingRoute(origin: Coordinate, destination: Coordinate, waypoints?: Coordinate[]): Promise<Route>

// æ­¥è¡Œè·¯çº¿
planWalkingRoute(origin: Coordinate, destination: Coordinate): Promise<Route>

// éª‘è¡Œè·¯çº¿
planRidingRoute(origin: Coordinate, destination: Coordinate): Promise<Route>

// å…¬äº¤è·¯çº¿
planTransitRoute(origin: Coordinate, destination: Coordinate, city: string): Promise<Route>
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. API Key å®‰å…¨
- ä½¿ç”¨ `NEXT_PUBLIC_` å‰ç¼€çš„ç¯å¢ƒå˜é‡
- åœ¨é«˜å¾·å¹³å°è®¾ç½®åŸŸåç™½åå•
- é™åˆ¶ API Key ä½¿ç”¨èŒƒå›´

### 2. åœ°ç†ç¼–ç é™é¢
- é«˜å¾·åœ°å›¾æœ‰æ¯æ—¥åœ°ç†ç¼–ç è¯·æ±‚é™é¢
- æ‰¹é‡åœ°ç†ç¼–ç æ—¶æ³¨æ„æ§åˆ¶æ•°é‡
- è€ƒè™‘ç¼“å­˜åœ°ç†ç¼–ç ç»“æœ

### 3. åœ°å›¾æ€§èƒ½
- æ™¯ç‚¹æ•°é‡è¿‡å¤šæ—¶ï¼Œè€ƒè™‘èšåˆæ˜¾ç¤º
- è·¯çº¿å¤æ‚æ—¶ï¼Œé€‚å½“ç®€åŒ–è·¯å¾„ç‚¹
- ä½¿ç”¨é˜²æŠ–å¤„ç†åœ°å›¾äº¤äº’äº‹ä»¶

### 4. æµè§ˆå™¨å…¼å®¹æ€§
- ç¡®ä¿ç›®æ ‡æµè§ˆå™¨æ”¯æŒ Geolocation API
- æµ‹è¯•ä¸åŒæµè§ˆå™¨çš„åœ°å›¾æ¸²æŸ“æ•ˆæœ
- æä¾›é™çº§æ–¹æ¡ˆï¼ˆæ— åœ°å›¾æ—¶æ˜¾ç¤ºæ–‡å­—ï¼‰

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šåœ°å›¾æ— æ³•åŠ è½½

**ç—‡çŠ¶**ï¼šåœ°å›¾åŒºåŸŸæ˜¾ç¤ºç©ºç™½æˆ–åŠ è½½å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `NEXT_PUBLIC_AMAP_KEY` æ˜¯å¦æ­£ç¡®é…ç½®
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
3. ç¡®è®¤é«˜å¾·åœ°å›¾ API Key å·²å¯ç”¨
4. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

### é—®é¢˜ 2ï¼šæ™¯ç‚¹ä½ç½®ä¸å‡†ç¡®

**ç—‡çŠ¶**ï¼šåœ°å›¾æ ‡è®°ä½ç½®åç§»æˆ–é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥åœ°å€ä¿¡æ¯æ˜¯å¦å®Œæ•´
2. æä¾›åŸå¸‚å‚æ•°ä»¥æé«˜åœ°ç†ç¼–ç å‡†ç¡®åº¦
3. ä½¿ç”¨æ›´å…·ä½“çš„åœ°å€ï¼ˆåŒ…å«åŒºå¿ã€è¡—é“ï¼‰
4. å¦‚æœæœ‰åæ ‡ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨åæ ‡

### é—®é¢˜ 3ï¼šè·¯çº¿è§„åˆ’å¤±è´¥

**ç—‡çŠ¶**ï¼šæ— æ³•æ˜¾ç¤ºè·¯çº¿æˆ–è§„åˆ’å‡ºé”™

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤èµ·ç‚¹å’Œç»ˆç‚¹åæ ‡æœ‰æ•ˆ
2. æ£€æŸ¥è·ç¦»æ˜¯å¦è¿‡è¿œï¼ˆæŸäº›äº¤é€šæ–¹å¼æœ‰è·ç¦»é™åˆ¶ï¼‰
3. å°è¯•å…¶ä»–äº¤é€šæ–¹å¼
4. æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

### é—®é¢˜ 4ï¼šå®šä½å¤±è´¥

**ç—‡çŠ¶**ï¼šæ— æ³•è·å–å½“å‰ä½ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤æµè§ˆå™¨å·²æˆäºˆå®šä½æƒé™
2. æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ”¯æŒ GPS
3. ç¡®è®¤æ˜¯ HTTPS ç¯å¢ƒï¼ˆHTTP å¯èƒ½æ— æ³•å®šä½ï¼‰
4. æä¾›é™çº§æ–¹æ¡ˆï¼ˆæ‰‹åŠ¨é€‰æ‹©ä½ç½®ï¼‰

## ğŸ“ ä¸‹ä¸€æ­¥

ç¬¬å…­é˜¶æ®µå®Œæˆåï¼Œåœ°å›¾åŠŸèƒ½å·²åŸºæœ¬å¯ç”¨ã€‚å¯ä»¥è€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–ï¼š

- ğŸ“ **POI æœç´¢**ï¼šæœç´¢é™„è¿‘çš„é¤å…ã€æ™¯ç‚¹ç­‰
- ğŸ›£ï¸ **å¤šæ—¥è·¯çº¿ä¼˜åŒ–**ï¼šä¼˜åŒ–æ•´ä¸ªè¡Œç¨‹çš„è·¯çº¿
- ğŸ“± **å®æ—¶å¯¼èˆª**ï¼šé›†æˆå®æ—¶å¯¼èˆªåŠŸèƒ½
- ğŸ—ºï¸ **ç¦»çº¿åœ°å›¾**ï¼šæ”¯æŒç¦»çº¿åœ°å›¾ä¸‹è½½
- ğŸ¨ **è‡ªå®šä¹‰æ ‡è®°**ï¼šä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡å’Œæ ·å¼
- ğŸ“Š **çƒ­åŠ›å›¾**ï¼šæ˜¾ç¤ºæ™¯ç‚¹çƒ­åº¦åˆ†å¸ƒ

---

**ç°åœ¨è¯·æŸ¥çœ‹æµ‹è¯•æŒ‡å—è¿›è¡ŒåŠŸèƒ½éªŒè¯ï¼** ğŸ“– [STAGE6_TEST_GUIDE.md](./STAGE6_TEST_GUIDE.md)

