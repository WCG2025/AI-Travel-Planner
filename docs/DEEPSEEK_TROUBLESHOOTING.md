# DeepSeek API 故障排除指南

## 🔍 问题诊断

### 步骤 1: 测试 API 连接

在浏览器中访问：
```
http://localhost:3000/api/test-deepseek
```

**预期结果**：
```json
{
  "success": true,
  "message": "DeepSeek API 连接成功",
  "duration": "1000-3000ms"
}
```

### 步骤 2: 检查环境变量

确认 `.env.local` 文件中的配置：

```env
DEEPSEEK_API_KEY=sk-xxxxxx  # 您的真实 API Key
NEXT_PUBLIC_DEEPSEEK_API_ENDPOINT=https://api.deepseek.com
```

**检查项**：
- [ ] API Key 是否正确（以 `sk-` 开头）
- [ ] 没有多余的空格或引号
- [ ] 重启开发服务器后生效

### 步骤 3: 验证 API Key 余额

1. 访问 DeepSeek 控制台
2. 检查账户余额
3. 确认 API Key 有效且未过期

## ⚠️ 常见错误

### 错误 1: Request timed out

**症状**：生成超过 30-60 秒后超时

**可能原因**：
1. **Prompt 太复杂** ✅ 已优化
2. **网络连接问题**
3. **DeepSeek 服务响应慢**
4. **API Key 配额不足**

**解决方案**：
1. 使用测试 API 检查基础连接
2. 尝试生成更短的行程（2-3天）
3. 检查网络代理设置
4. 验证 API Key 余额

### 错误 2: Invalid API Key

**症状**：401 Unauthorized

**解决方案**：
1. 重新检查 `.env.local` 中的 API Key
2. 确保 API Key 正确复制（无空格）
3. 重启开发服务器

### 错误 3: Rate Limit Exceeded

**症状**：429 Too Many Requests

**解决方案**：
1. 等待 1-2 分钟后重试
2. 检查账户限额
3. 考虑升级 API 计划

## 🔧 优化建议

### 1. 简化 Prompt（已实施）

我们已经将 Prompt 从详细版本简化为精简版本：
- 减少示例说明
- 降低 maxTokens（4000 → 3000）
- 简化输出格式说明

### 2. 分段生成（未来优化）

对于长行程（7+ 天），考虑：
- 分批生成（每次 2-3 天）
- 使用流式响应
- 后台队列处理

### 3. 备用方案

如果 DeepSeek 持续不稳定，可以考虑：
- 使用其他 AI 服务（OpenAI、Azure OpenAI）
- 缓存常见目的地的模板
- 混合使用 AI + 模板

## 📊 性能基准

### 优化前
| 行程 | 生成时间 | 状态 |
|-----|---------|------|
| 3天  | 超时     | ❌   |
| 5天  | 超时     | ❌   |

### 优化后（预期）
| 行程 | 生成时间 | 状态 |
|-----|---------|------|
| 3天  | 10-20秒  | ✅   |
| 5天  | 20-40秒  | ✅   |
| 7天  | 40-80秒  | ⚠️   |

## 🧪 快速测试

### 测试 1: API 连接
```bash
# 访问
http://localhost:3000/api/test-deepseek

# 预期：3秒内返回成功
```

### 测试 2: 简单行程
```
目的地：北京
天数：2天
预算：2000

# 预期：15秒内生成成功
```

### 测试 3: 中等行程
```
目的地：上海
天数：5天
预算：5000

# 预期：30-40秒内生成成功
```

## 🆘 仍然失败？

如果经过上述步骤仍然失败，请提供：

1. **测试 API 的返回结果**
2. **浏览器控制台的完整错误**
3. **终端的完整日志**
4. **DeepSeek 账户状态截图**

这将帮助进一步诊断问题。

## 📝 临时解决方案

如果急需使用，可以暂时：

1. **使用更短的行程**（2-3天）
2. **减少天数限制**（目前限制 10 天）
3. **简化需求描述**
4. **分多次生成**（如 7 天行程分为前 4 天 + 后 3 天）

---

**更新时间**: 2025-01-30  
**状态**: 已优化 Prompt 和超时配置

