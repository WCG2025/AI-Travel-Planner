# 语音直接生成旅行计划

## 🎯 功能说明

现在，用户可以**完全通过语音创建旅行计划**，无需手动填写表单！

### 工作流程

#### ❌ 之前（需要切换表单）
```
用户语音输入 → 转为文本 → 切换到表单 → 手动填写目的地、日期等 → 生成计划
```
**问题**：语音输入失去意义，还是需要手动填表单

#### ✅ 现在（直接生成）
```
用户语音输入 → AI 解析提取信息 → 直接生成计划
```
**优势**：真正的语音全流程，无需任何手动输入！

---

## 🔧 技术实现

### 1. AI 自然语言解析（`parse-travel-request.ts`）

新增了一个 AI 解析模块，能够从自然语言中提取结构化信息：

```typescript
export interface ParsedTravelRequest {
  destination?: string;        // 目的地
  startDate?: string;          // 开始日期
  endDate?: string;            // 结束日期
  days?: number;               // 天数
  budget?: number;             // 预算（元）
  travelers?: number;          // 人数
  interests?: string[];        // 兴趣爱好
  pace?: 'relaxed' | 'moderate' | 'fast';  // 节奏
  specialRequirements?: string; // 原始文本
  confidence: 'high' | 'medium' | 'low';   // 解析置信度
  missingFields: string[];      // 缺失字段
}
```

#### 解析示例

**输入（语音）**：
> "我想去北京旅游三天，预算五千元，喜欢历史文化和美食"

**AI 解析输出**：
```json
{
  "destination": "北京",
  "days": 3,
  "startDate": "2025-11-01",
  "endDate": "2025-11-03",
  "budget": 5000,
  "travelers": 1,
  "interests": ["history", "food"],
  "pace": "moderate",
  "confidence": "high",
  "missingFields": []
}
```

#### 智能特性

1. **日期推断**
   - 没有明确开始日期时，默认为明天
   - 根据天数自动计算结束日期

2. **兴趣识别**
   - "历史文化" → `history`
   - "美食" → `food`
   - "自然风光" → `nature`
   - "购物" → `shopping`
   - 等等...

3. **置信度评估**
   - `high`: 所有必需字段都识别出来
   - `medium`: 部分字段识别出来
   - `low`: 缺少关键信息

4. **缺失字段提示**
   - 如果无法识别目的地或日期，会明确告知用户

### 2. 前端 UI 改进（`plan-form.tsx`）

#### 新增状态管理

```typescript
const [voiceText, setVoiceText] = useState<string>('');  // 语音文本
const [parsing, setParsing] = useState(false);           // 解析中
const [parseError, setParseError] = useState<string | null>(null);  // 错误
```

#### 语音提交流程

```typescript
const handleVoiceSubmit = async () => {
  // 1. 检查语音输入
  if (!voiceText.trim()) {
    setParseError('请先使用语音输入');
    return;
  }
  
  // 2. AI 解析
  const parsed = await parseTravelRequest(voiceText);
  
  // 3. 验证必需字段
  if (parsed.missingFields.length > 0) {
    setParseError(`无法识别出${parsed.missingFields.join('、')}`);
    return;
  }
  
  // 4. 构建输入并提交
  const input: TravelPlanInput = { ... };
  await onSubmit(input);
};
```

#### UI 优化

**语音输入提示**：
```
💡 语音输入提示：
请清晰描述您的旅行需求，包括：
• 目的地（必需）：例如"北京"
• 时长（必需）：例如"三天"或"2天"
• 预算（可选）：例如"预算五千元"
• 兴趣（可选）：例如"喜欢历史文化和美食"

示例："我想去北京旅游三天，预算五千元，喜欢历史文化和美食"
```

**按钮设计**：
- **主按钮**："创建旅行计划"（直接从语音生成）
- **次按钮**："表单输入"（如果想手动填写）

---

## 📊 用户体验流程

### 场景 1: 完整描述 ✅

1. 用户点击"语音输入"标签
2. 录音："我想去北京旅游三天，预算五千元，喜欢历史文化和美食"
3. 点击"创建旅行计划"
4. AI 显示"AI 正在解析..."
5. 解析成功，开始生成计划
6. 显示进度条和进度信息
7. 生成完成，显示计划详情 ✅

**终端日志**：
```bash
🎤 开始解析语音需求...
📝 输入文本: 我想去北京旅游三天，预算五千元，喜欢历史文化和美食
🤖 AI 原始返回: {"destination":"北京","days":3,...
✅ 解析成功: { destination: '北京', days: 3, ... }
📊 最终解析结果: { destination: '北京', startDate: '2025-11-01', ... }
✅ 准备提交: { destination: '北京', startDate: '2025-11-01', ... }
```

### 场景 2: 信息不完整 ⚠️

1. 用户录音："我想去旅游"（缺少目的地和日期）
2. 点击"创建旅行计划"
3. AI 解析后发现缺少必需字段
4. 显示错误提示："从您的描述中无法识别出目的地、dates。请补充描述，或切换到表单输入模式。"
5. 用户可以选择：
   - 重新录音，提供更多信息
   - 切换到表单输入

### 场景 3: 解析失败 ❌

1. 用户录音内容 AI 无法理解
2. 点击"创建旅行计划"
3. 显示错误："语音解析失败，请重试或使用表单输入"
4. 用户可以切换到表单输入

---

## 🧪 测试指南

### 测试用例 1: 标准描述

**语音输入**：
> "我想去北京旅游三天，预算五千元，喜欢历史文化和美食"

**预期结果**：
- ✅ 成功解析
- ✅ 目的地：北京
- ✅ 天数：3天
- ✅ 预算：5000元
- ✅ 兴趣：历史文化、美食
- ✅ 直接生成计划

### 测试用例 2: 简洁描述

**语音输入**：
> "去杭州玩两天"

**预期结果**：
- ✅ 成功解析
- ✅ 目的地：杭州
- ✅ 天数：2天
- ✅ 直接生成计划

### 测试用例 3: 详细描述

**语音输入**：
> "我和老婆想去三亚度假五天，我们比较喜欢海滩和水上运动，预算一万块左右，希望节奏放松一点"

**预期结果**：
- ✅ 成功解析
- ✅ 目的地：三亚
- ✅ 天数：5天
- ✅ 预算：10000元
- ✅ 人数：2人
- ✅ 兴趣：海滩、水上运动
- ✅ 节奏：放松
- ✅ 直接生成计划

### 测试用例 4: 缺少关键信息

**语音输入**：
> "我想去旅游，喜欢美食"

**预期结果**：
- ⚠️ 解析失败
- ⚠️ 提示：无法识别出目的地、dates
- ⚠️ 建议补充描述或使用表单

### 测试用例 5: 多次累积录音

**第一次录音**：
> "我想去北京旅游三天"

**第二次录音（累积）**：
> "预算五千元，喜欢历史文化"

**点击"创建旅行计划"**：

**预期结果**：
- ✅ AI 解析完整的累积文本
- ✅ 成功识别所有信息
- ✅ 直接生成计划

---

## 🚀 优势与价值

### 1. 极致便捷
- **零手动输入**：从录音到计划生成，全程语音
- **适合移动端**：手机上语音输入远比打字方便
- **适合老年人**：不熟悉键盘的用户群体

### 2. 自然交互
- **像说话一样**：用户用自然语言描述旅行需求
- **无需记忆格式**：不需要知道表单有哪些字段
- **灵活多样**：各种描述方式都能识别

### 3. 智能辅助
- **自动推断**：没说开始日期？默认明天
- **兴趣识别**：自动将"历史文化"映射到标准分类
- **错误提示**：清晰告知缺少哪些信息

### 4. 双模式兼容
- **灵活切换**：语音不满意，可以切换到表单
- **互补使用**：语音描述大致需求，表单精细调整

---

## 📈 未来优化方向

### 1. 更智能的日期解析
```
"下周五去北京" → 自动计算具体日期
"春节期间去三亚" → 识别节假日
"周末两天" → 识别最近的周末
```

### 2. 上下文理解
```
用户："我想去北京"
AI: "好的，去几天呢？"
用户："三天"
AI: 自动关联到北京
```

### 3. 多轮对话
```
AI: "您的预算大概是多少？"
用户："五千左右"
AI: "了解，喜欢什么类型的活动？"
用户："历史文化"
```

### 4. 方言识别
- 支持广东话、四川话等方言
- 自动转换为普通话进行解析

### 5. 语音确认
```
AI 语音播报: "我理解您要去北京旅游三天，预算五千元，对吗？"
用户："对的"
AI: 开始生成计划
```

---

## 🔧 维护与调试

### 查看解析日志

在浏览器控制台中：
```bash
🎤 开始解析语音需求...
📝 输入文本: ...
🤖 AI 原始返回: ...
✅ 解析成功: ...
📊 最终解析结果: ...
```

### 常见问题

**Q: AI 无法识别目的地？**
A: 确保目的地表述清晰，避免过于含糊（如"那个地方"）

**Q: 日期解析不准确？**
A: 尽量使用"三天"、"2天"这种明确的天数表述

**Q: 预算识别错误？**
A: 使用"五千元"、"5000块"等明确表述

**Q: 解析速度慢？**
A: AI 解析通常需要 1-3 秒，属于正常范围

---

## ✅ 验收标准

- [ ] 用户可以通过语音输入完整描述旅行需求
- [ ] AI 能够正确解析目的地、天数、预算等信息
- [ ] 解析成功后直接生成计划，无需切换表单
- [ ] 解析失败时给出明确的错误提示
- [ ] 终端日志清晰显示解析过程
- [ ] 用户可以选择切换到表单输入模式
- [ ] 语音输入内容正确显示在界面上
- [ ] 支持多次录音的累积

---

**更新时间**: 2025-10-31  
**版本**: v1.0  
**状态**: ✅ 已实现

