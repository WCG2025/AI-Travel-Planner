# 高德地图 Web服务 API 配置指南

## 🎯 为什么需要 Web服务 API

### API 类型区别

高德地图提供两种不同类型的 API：

| API 类型 | 用途 | 使用场景 | 环境 |
|---------|------|---------|------|
| **Web端（JS API）** | 地图显示 | 前端地图渲染、标记、路线绘制 | 客户端 |
| **Web服务 API** | 数据查询 | 地理编码、搜索、路径规划等 | 服务端 |

**关键点**：
- ✅ JS API 用于显示地图
- ✅ Web服务 API 用于将地址转换为坐标（地理编码）
- ⚠️ 两者需要**不同的 API Key**

---

## 📋 配置步骤

### 第一步：获取 Web服务 API Key

1. 登录 [高德开放平台控制台](https://console.amap.com/)
2. 进入"应用管理" → "我的应用"
3. 找到您的应用，点击"添加 Key"
4. **关键**：选择 **"Web服务"** 类型（不是 Web端（JS API））
5. 填写 Key 名称（如"AI-Travel-Planner-WebService"）
6. 点击"提交"
7. 复制生成的 Key

### 第二步：配置环境变量

在项目根目录的 `.env.local` 文件中添加：

```env
# 高德地图配置
NEXT_PUBLIC_AMAP_KEY=your_js_api_key  # JS API - 用于地图显示（客户端）
AMAP_WEB_SERVICE_KEY=your_web_service_key  # Web服务API - 用于地理编码（服务端）⬅️ 新增
```

**注意**：
- `NEXT_PUBLIC_AMAP_KEY` - 前缀 `NEXT_PUBLIC_` 表示客户端可访问
- `AMAP_WEB_SERVICE_KEY` - 无前缀，仅服务端可访问（更安全）

### 第三步：重启开发服务器

**必须重启！** 环境变量修改后需要重启：

```bash
# 停止当前服务器（Ctrl + C）

# 重新启动
npm run dev
```

---

## ✅ 验证配置

### 方法1：查看服务器日志

启动服务器后，不应该看到这个错误：
```
❌ AMAP_WEB_SERVICE_KEY 未配置
```

### 方法2：测试地理编码

1. 刷新浏览器页面
2. 创建新的旅行计划（或打开现有计划）
3. 切换到"地图导航"标签页
4. 打开浏览器控制台（F12）

**成功的日志**：
```
🔄 批量地理编码: 8 个地址，并发数: 5 (使用服务端API)
📦 处理批次 1/2: 5 个地址
   → 正在编码 [1/8]: 南京玄武区紫金山南麓
✅ 地理编码成功: 南京玄武区紫金山南麓 → (118.xxx, 32.xxx)
✅ 批次 1 完成: 5/5 成功 (耗时 1.2秒)
✅ 批量地理编码完成: 8/8 成功 (总耗时 2.3秒)
```

**失败的日志**：
```
❌ 地理编码失败: Web服务 API Key 未配置
```

### 方法3：检查地图

- ✅ 地图上显示景点标记
- ✅ 标记位置准确
- ✅ 点击标记显示信息窗口
- ✅ 加载时间 < 5秒

---

## 🔍 故障排查

### 问题1：提示"Web服务 API Key 未配置"

**原因**：环境变量未正确配置

**解决方案**：
1. 检查 `.env.local` 文件中是否有 `AMAP_WEB_SERVICE_KEY`
2. 确认 Key 值正确（无空格、无引号）
3. 重启开发服务器

### 问题2：地理编码失败，返回"INVALID_USER_KEY"

**原因**：API Key 无效或类型错误

**解决方案**：
1. 确认 Key 类型是 **"Web服务"**（不是 Web端（JS API））
2. 检查 Key 状态是"正常"（不是已停用）
3. 确认 Key 有地理编码服务权限

### 问题3：地理编码成功但坐标不准确

**原因**：AI 生成的地址不够详细

**解决方案**：
1. 检查控制台日志中的地址
2. 如果地址太模糊（如"南京秦淮区贡院街"），可以：
   - 重新生成行程，让 AI 提供更详细的地址
   - 或者手动在数据库中修改地址

### 问题4：部分景点地理编码失败

**原因**：地址无法识别或服务限流

**解决方案**：
1. 查看失败的地址
2. 尝试简化地址或使用更常见的表述
3. 检查 API 配额是否用完

---

## 📊 性能对比

### 使用 Web服务 API（当前方案）

**优点**：
- ✅ 坐标准确（官方地理编码）
- ✅ 稳定可靠
- ✅ API Key 安全（服务端）
- ✅ 支持详细地址解析

**缺点**：
- ⚠️ 需要额外申请 Key
- ⚠️ 需要网络请求（增加 1-2秒）

**性能**：
- 8个景点：2-3秒
- 15个景点：4-5秒

### 使用 AI 生成坐标（之前的临时方案）

**优点**：
- ✅ 不需要额外 API Key
- ✅ 加载快（0秒地理编码）

**缺点**：
- ❌ 坐标可能不准确
- ❌ AI 可能生成错误的坐标
- ❌ 对详细地址支持差

**结论**：**建议使用 Web服务 API**，坐标准确性更重要。

---

## 🔐 安全最佳实践

### ✅ 正确做法

```env
# .env.local（不提交到 Git）
AMAP_WEB_SERVICE_KEY=your_actual_key  # 仅服务端可访问
```

### ❌ 错误做法

```env
# 不要这样！
NEXT_PUBLIC_AMAP_WEB_SERVICE_KEY=your_key  # 会暴露给客户端！
```

**重要**：
- Web服务 API Key **不应该**有 `NEXT_PUBLIC_` 前缀
- 这样 Key 只在服务端可用，不会暴露给浏览器
- 更安全，防止 Key 被滥用

---

## 📚 相关文档

- [高德地图 Web服务 API 文档](https://lbs.amap.com/api/webservice/summary)
- [地理编码 API 说明](https://lbs.amap.com/api/webservice/guide/api/georegeo)
- [如何申请 Key](https://lbs.amap.com/api/webservice/guide/create-project/get-key)
- [API Key 使用限制](https://lbs.amap.com/api/webservice/guide/tools/flowlevel)

---

## 💰 配额说明

### 免费额度

- **个人开发者**：每天 30万次
- **企业开发者**：每天 100万次

### 配额监控

1. 登录高德控制台
2. 查看"应用管理" → "使用统计"
3. 监控每日调用次数

### 优化建议

1. **缓存结果** - 相同地址不重复请求
2. **批量处理** - 当前已实现（5个并发）
3. **合并请求** - 多个用户查看同一计划时共享结果

---

## ✅ 配置完成！

完成以上步骤后，您的地图导航功能应该能够正常工作：

- ✅ 准确的景点坐标
- ✅ 快速的地理编码（2-3秒）
- ✅ 稳定可靠的服务
- ✅ 安全的 API Key 管理

**如有问题，请参考故障排查部分或查看控制台日志。** 🗺️✨

