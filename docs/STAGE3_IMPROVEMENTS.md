# 第三阶段改进日志

## 📅 更新日期：2025-10-30

## 🐛 修复的问题

### 1. WebSocket 自动断开问题

**问题描述**：
- 用户反馈：停几秒就会自动断开语音识别的 WebSocket 连接
- 原因：科大讯飞服务器有静音超时机制，10秒无声音输入会自动断开连接

**解决方案**：
- ✅ 添加了 `onClose` 回调监听 WebSocket 断开事件
- ✅ 在 WebSocket 断开时自动停止录音
- ✅ 根据是否有识别结果判断是正常结束还是异常断开
- ✅ 提供友好的错误提示，说明超时原因

**修改文件**：
- `src/lib/voice/xfyun-client.ts`
- `src/hooks/use-voice-recognition.ts`

### 2. 识别文本重复问题

**问题描述**：
- 用户反馈：识别返回的文本内容有重复

**原因分析**：
- 科大讯飞返回的是流式累积结果，每次返回的都是从开始到当前的完整文本
- 代码中使用 `setText((prev) => prev + result.text)` 是累加操作，导致重复

**解决方案**：
- ✅ 改为 `setText(result.text)` 直接替换文本，不再累加
- ✅ 使用 `textRef.current` 保存最新文本，避免闭包问题

**修改文件**：
- `src/hooks/use-voice-recognition.ts`

### 3. 缺少首帧标识

**问题描述**：
- 代码没有发送 status=0 的首帧标识
- 科大讯飞 API 要求：首帧(status=0)、中间帧(status=1)、尾帧(status=2)

**解决方案**：
- ✅ 添加 `isFirstFrame` 标志
- ✅ 首次发送音频时标记为 status=0
- ✅ 后续帧标记为 status=1
- ✅ 结束时标记为 status=2

**修改文件**：
- `src/lib/voice/xfyun-client.ts`

### 4. 静音超时配置

**问题描述**：
- 没有明确配置静音超时时间
- 用户不知道会在多久后自动断开

**解决方案**：
- ✅ 添加 `vad_eos: 10000` 参数（10秒静音超时）
- ✅ 在配置文件中添加说明
- ✅ 在 UI 提示中告知用户

**修改文件**：
- `src/lib/voice/xfyun-client.ts`
- `src/lib/voice/voice-config.ts`
- `src/components/features/voice/voice-input.tsx`

---

## ✨ 新增功能

### 1. WebSocket 连接状态监听

**功能**：
- 新增 `onClose(callback)` 方法，监听 WebSocket 断开
- 新增 `isConnected()` 方法，检查连接状态
- 自动识别断开原因（正常关闭、超时、其他）

**代码示例**：
```typescript
client.onClose(() => {
  console.log('连接已断开');
  // 自动停止录音
  // 更新 UI 状态
});
```

### 2. 智能错误处理

**功能**：
- 区分正常结束和异常断开
- 如果已有识别结果，视为正常结束
- 如果无识别结果，显示超时提示
- 提供详细的错误信息和使用建议

**效果**：
- ✅ 已获取到识别结果 → 状态变为 idle，正常结束
- ❌ 未获取到结果 → 状态变为 error，显示超时提示

### 3. 日志优化

**改进**：
- 使用 emoji 标记不同类型的日志（📤 发送、✅ 成功、⚠️ 警告、❌ 错误）
- 减少中间帧日志输出（只打印 10% 避免刷屏）
- 添加更详细的状态说明

**效果**：
```
📤 发送首帧，大小: 8192 字节
📤 发送音频数据，大小: 8192 字节
📤 发送尾帧
⚠️ WebSocket 连接关闭: 1000 正常关闭
✅ 已获取到识别结果，连接正常结束
```

### 4. 用户提示改进

**改进**：
- 添加静音超时提示
- 提供使用建议（保持连续说话、避免长时间停顿）
- 说明分段录制方案

**位置**：
- 使用说明卡片
- 错误提示信息
- 配置文件注释

---

## 🔧 技术改进

### 1. 代码结构优化

**改进点**：
- 使用 `useRef` 解决闭包问题
- 添加状态管理标志（`isFirstFrame`）
- 改进回调函数结构

### 2. WebSocket 参数优化

**新增参数**：
```typescript
business: {
  language: 'zh_cn',
  accent: 'mandarin',
  domain: 'iat',
  dwa: 'wpgs',          // 动态修正
  vad_eos: 10000,       // 静音超时 10 秒
  ptt: 0,               // 标点符号
}
```

### 3. 错误边界处理

**改进**：
- 所有异步操作都包裹在 try-catch 中
- WebSocket 状态检查更完善
- 资源清理更彻底

---

## 📊 性能优化

### 1. 日志输出优化

- 中间帧只打印 10% 的日志
- 减少控制台刷屏
- 保留关键信息（首帧、尾帧、结果）

### 2. 状态管理优化

- 使用 `useRef` 避免不必要的重渲染
- 及时清理资源
- 防止内存泄漏

---

## 📝 配置变更

### voice-config.ts 新增配置

```typescript
recognition: {
  vadEos: 10000,  // 静音超时时间(毫秒)
},
tips: {
  silenceTimeout: '连续10秒无声音输入，科大讯飞服务器会自动断开连接',
  continuous: '说话时尽量保持连续，避免长时间停顿',
}
```

---

## 🧪 测试建议

### 测试场景 1：正常使用流程

1. 点击"开始语音输入"
2. 连续说话 3-5 秒
3. 点击"停止录音"
4. **预期**：正常获取识别结果

### 测试场景 2：静音超时

1. 点击"开始语音输入"
2. 说话 2-3 秒
3. 保持静音超过 10 秒
4. **预期**：
   - WebSocket 自动断开
   - 录音自动停止
   - 显示已获取的识别结果
   - 状态变为 idle

### 测试场景 3：未说话超时

1. 点击"开始语音输入"
2. 不说话，保持静音 10 秒
3. **预期**：
   - WebSocket 自动断开
   - 录音自动停止
   - 显示超时错误提示
   - 状态变为 error

---

## 💡 使用建议

### 最佳实践

1. **连续说话**：尽量一次性说完，避免中间停顿太久
2. **分段录制**：如果内容较长，建议分多次录制
3. **及时停止**：说完后尽快点击"停止录音"
4. **检查结果**：每次录制后检查识别结果是否准确

### 避免的操作

1. ❌ 说一句话停很久再说下一句
2. ❌ 开始录音后长时间不说话
3. ❌ 一次录制超长内容（建议单次不超过 30 秒）

---

## 📈 改进效果

### 用户体验提升

- ✅ **问题明确**：用户知道为什么会断开连接
- ✅ **操作指引**：提供清晰的使用建议
- ✅ **状态反馈**：自动处理断开，无需手动操作
- ✅ **结果可靠**：文本不再重复，识别更准确

### 代码质量提升

- ✅ **错误处理更完善**
- ✅ **日志信息更清晰**
- ✅ **状态管理更可靠**
- ✅ **资源清理更彻底**

---

## 🔄 版本对比

### 修复前

```typescript
// 文本累加（错误）
setText((prev) => prev + result.text);

// 没有首帧标识
status: isLast ? 2 : 1

// 没有断开监听
// WebSocket 断开时用户不知道发生了什么
```

### 修复后

```typescript
// 文本替换（正确）
setText(result.text);
textRef.current = result.text;

// 正确的帧标识
status: isLast ? 2 : (isFirstFrame ? 0 : 1)

// 添加断开监听
client.onClose(() => {
  // 自动停止录音
  // 智能判断状态
  // 友好提示
});
```

---

## 🎯 后续优化方向

### 可选改进

1. **动态调整超时时间**
   - 允许用户自定义静音超时时间
   - 根据使用场景调整（快速输入 vs 慢速输入）

2. **断点续传**
   - WebSocket 断开后自动重连
   - 继续之前的识别会话

3. **语音活动检测**
   - 前端检测是否有声音输入
   - 提前提示用户"未检测到声音输入"

4. **识别质量指示**
   - 显示识别置信度
   - 对低置信度的结果标记提示

---

## 📚 相关文档

- 科大讯飞官方文档：https://www.xfyun.cn/doc/asr/voicedictation/API.html
- WebSocket 状态码：https://developer.mozilla.org/zh-CN/docs/Web/API/CloseEvent
- 第三阶段配置指南：`docs/STAGE3_SETUP.md`
- 第三阶段完成报告：`docs/STAGE3_COMPLETE.md`

---

**更新者**：AI Travel Planner Team  
**更新日期**：2025-10-30  
**版本**：v1.1

