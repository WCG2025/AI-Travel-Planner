# 地图 NaN 错误排查指南

## 🐛 问题描述

控制台出现大量的 `Invalid Object: LngLat(NaN, NaN)` 或 `Invalid Object: Pixel(NaN, NaN)` 错误。

### 错误特征

```
Uncaught Error: Invalid Object: LngLat(NaN, NaN)
Uncaught Error: Invalid Object: Pixel(NaN, NaN)
Uncaught TypeError: Cannot read properties of undefined (reading '0')
```

这些错误来自高德地图内部代码，说明传递给地图API的某些坐标是 NaN。

---

## 🔍 可能原因

### 1. 旧的行程数据

**问题**：
- 使用的是修改代码之前生成的行程
- 旧行程可能缺少必要的地址字段
- 地理编码失败但标记仍然被创建

**识别方法**：
查看控制台是否有：
```
✅ 创建标记: "景点名" at [118.xxx, 32.xxx]
```

如果没有这些日志，说明标记创建被跳过了。

### 2. 地理编码部分失败

**问题**：
- 8个景点中有的成功，有的失败
- 失败的景点可能产生 null 或 undefined 坐标

**识别方法**：
查看：
```
✅ 批量地理编码完成: 7/8 成功  ← 不是 8/8
```

### 3. 地图控件问题

**问题**：
- Scale 或 ToolBar 控件可能有问题
- 控件在渲染时访问了无效坐标

---

## ✅ 解决方案

### 方案 A：创建新的旅行计划（推荐）

**步骤**：

1. **删除旧计划**
   - 在计划列表中删除"南京"行程
   
2. **创建新计划**
   - 使用语音或表单创建
   - 确保 AI 返回详细地址
   
3. **打开地图**
   - 切换到"地图导航"标签页
   - 查看是否仍有 NaN 错误

**预期结果**：
```
✅ 批量地理编码完成: 8/8 成功
✅ 创建标记: "中山陵" at [118.847100, 32.066100]
✅ 创建标记: "夫子庙" at [118.790293, 32.020507]
...
✅ 成功加载 8 个地点，2 条连线
```

无 NaN 错误！

---

### 方案 B：清除浏览器缓存

**步骤**：

1. 按 `Ctrl + Shift + Delete`
2. 选择"缓存的图片和文件"
3. 点击"清除数据"
4. 刷新页面（Ctrl + Shift + R）

**原因**：
- 浏览器可能缓存了旧的地图脚本
- 或缓存了损坏的数据

---

### 方案 C：禁用地图控件（诊断）

如果是控件问题，可以临时禁用来确认：

修改 `src/components/features/map/map-container.tsx`：

```typescript
// 临时注释掉控件
// if (finalConfig.showScale) {
//   mapInstance.addControl(new amap.Scale());
// }

// if (finalConfig.showCompass) {
//   mapInstance.addControl(new amap.ToolBar());
// }
```

如果 NaN 错误消失，说明是控件问题。

---

### 方案 D：完全重新实现标记（如果上述都失败）

使用最简配置：

```typescript
// 最简标记配置
const marker = new AMap.Marker({
  position: new AMap.LngLat(lng, lat),
  title: activity.title,
  // 不使用 label、icon、offset
});

marker.setMap(map);
```

逐步添加功能，找出哪个配置导致 NaN。

---

## 🧪 测试新行程

### 推荐测试步骤

1. **创建全新行程**
   ```
   目的地：成都
   天数：2天
   预算：2000元
   ```

2. **确认 AI 返回详细地址**
   查看行程详情，每个景点应该有：
   - title: "宽窄巷子"
   - location: "宽窄巷子"
   - address: "成都市青羊区金河路口宽窄巷子"  ← 关键！

3. **打开地图导航**
   - 等待 3-4 秒
   - 查看控制台日志

4. **验证无 NaN 错误**
   - 地图应该正常显示
   - 可以拖动缩放
   - 点击标记显示信息

---

## 📋 诊断检查清单

当出现 NaN 错误时，按顺序检查：

- [ ] 控制台是否显示"创建标记"日志？
  - 有 → 标记创建成功
  - 无 → 标记被跳过，检查坐标验证

- [ ] 地理编码成功率？
  - 8/8 → 全部成功，问题在其他地方
  - 7/8 或更少 → 部分失败，可能影响地图

- [ ] 是否使用旧的行程数据？
  - 是 → 建议创建新行程
  - 否 → 继续排查

- [ ] 浏览器缓存是否已清除？
  - 已清除 → 继续排查
  - 未清除 → 先清除缓存

- [ ] 地图控件是否正常？
  - 正常 → 继续排查
  - 异常 → 尝试禁用控件

---

## 💡 临时解决方案

如果急需使用地图功能，可以暂时：

### 1. 忽略 NaN 警告

这些警告来自高德地图内部，如果：
- ✅ 地图可以显示
- ✅ 标记可以看到
- ✅ 可以交互（拖动、缩放、点击）

**则可以暂时忽略这些警告**，它们不影响核心功能。

### 2. 使用最小化配置

暂时移除：
- label（标签）
- 自定义 icon
- offset

只保留基本标记功能。

---

## 🎯 最佳实践

### 避免 NaN 错误的建议

1. **总是验证坐标**
   ```typescript
   if (coord && !isNaN(coord.lng) && !isNaN(coord.lat)) {
     // 使用坐标
   }
   ```

2. **使用 LngLat 对象**
   ```typescript
   position: new AMap.LngLat(lng, lat)  // ✅ 推荐
   // vs
   position: [lng, lat]  // ⚠️ 可能有问题
   ```

3. **包裹在 try-catch 中**
   ```typescript
   try {
     const marker = new AMap.Marker({...});
   } catch (error) {
     console.error('标记创建失败', error);
   }
   ```

4. **添加详细日志**
   ```typescript
   console.log(`坐标: ${coord.lng}, ${coord.lat}`);
   ```

---

## 🔄 下一步操作

### 立即执行

1. **刷新页面**（Ctrl + Shift + R）
2. **查看控制台**
3. **查找这些关键日志**：
   ```
   → 创建标记: "景点名" at [118.xxx, 32.xxx]
   ```

### 如果仍有 NaN 错误

1. **创建新的旅行计划**（不同城市也可以）
2. **测试新计划的地图**
3. **对比错误数量**

### 如果新计划正常

说明是旧数据问题：
- 删除所有旧计划
- 只使用新生成的计划

### 如果新计划也有错误

说明是代码问题：
- 提供完整的控制台日志
- 我会进一步排查

---

## 📞 需要的信息

如果问题仍未解决，请提供：

1. **是否看到 "创建标记" 日志？**
2. **地理编码成功率？**（X/8）
3. **使用的是新计划还是旧计划？**
4. **地图是否能正常显示和交互？**

---

**建议：先创建一个新的旅行计划来测试！** 🗺️

这样可以排除旧数据的影响。

