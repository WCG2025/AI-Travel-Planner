# 第五阶段测试指南：费用预算与管理

## 测试前准备

### 1. 应用数据库迁移

有两种方式应用数据库迁移：

#### 方式一：使用 Supabase CLI（推荐）

```bash
# 如果安装了 Supabase CLI
supabase db push
```

#### 方式二：手动执行 SQL（如果没有 CLI）

1. 登录 [Supabase Dashboard](https://app.supabase.com)
2. 选择你的项目
3. 进入 **SQL Editor**
4. 复制 `supabase/migrations/20251031_create_expenses_table.sql` 的内容
5. 粘贴并执行

### 2. 验证数据库表

在 Supabase SQL Editor 中运行：

```sql
-- 检查 expenses 表是否创建成功
SELECT * FROM expenses LIMIT 1;

-- 检查 RLS 策略
SELECT * FROM pg_policies WHERE tablename = 'expenses';
```

### 3. 启动开发服务器

```bash
npm run dev
```

## 功能测试清单

### ✅ 测试 1: 手动添加费用

1. 创建或打开一个旅行计划
2. 点击"费用管理"标签页
3. 点击"添加费用"按钮
4. 在"手动输入"标签页中填写：
   - 类别：选择"餐饮"
   - 金额：68.50
   - 描述：午餐 - 川菜馆
   - 日期：选择今天
5. 点击"保存费用"
6. 验证：
   - ✅ 费用成功保存
   - ✅ 列表中显示新增费用
   - ✅ 统计卡片数据更新（总支出、记录数等）

### ✅ 测试 2: 语音添加费用

1. 在"添加费用"对话框中，切换到"语音输入"标签页
2. 点击麦克风图标开始录音
3. 说出费用信息（示例）：
   - "今天午餐花了 68 块"
   - "打车去机场 120 元"
   - "昨天住酒店 350"
4. 点击停止录音
5. 点击"应用到表单"
6. 验证：
   - ✅ AI 正确解析出金额
   - ✅ AI 正确识别出类别（餐饮/交通/住宿）
   - ✅ 如有描述，正确提取描述信息
   - ✅ 日期正确（今天或昨天）
7. 检查表单，必要时手动修正
8. 点击"保存费用"
9. 验证：
   - ✅ 费用成功保存

### ✅ 测试 3: 编辑费用

1. 在费用列表中，找到一条记录
2. 点击"编辑"按钮
3. 修改金额（例如从 68 改为 75）
4. 修改描述
5. 点击"保存费用"
6. 验证：
   - ✅ 费用更新成功
   - ✅ 列表显示更新后的数据
   - ✅ 统计数据重新计算

### ✅ 测试 4: 删除费用

1. 在费用列表中，找到一条记录
2. 点击"删除"按钮
3. 确认删除（如果有确认对话框）
4. 验证：
   - ✅ 费用从列表中移除
   - ✅ 统计数据重新计算
   - ✅ 如果是最后一条记录，显示空状态

### ✅ 测试 5: 费用统计卡片

添加多条不同类别、不同日期的费用后，验证统计卡片：

1. **总支出卡片**：
   - ✅ 显示所有费用的总和
   - ✅ 如果设置了预算，显示预算金额

2. **剩余预算卡片**（如果设置了预算）：
   - ✅ 显示剩余预算（预算 - 总支出）
   - ✅ 显示预算使用百分比
   - ✅ 颜色正确：
     - 绿色：< 80%（安全）
     - 黄色：80-100%（警告）
     - 红色：> 100%（超支）

3. **记录数卡片**：
   - ✅ 显示费用记录总数
   - ✅ 显示平均消费（总支出 / 记录数）

4. **消费分类卡片**：
   - ✅ 显示使用的分类数量
   - ✅ 显示消费最多的分类名称

### ✅ 测试 6: 分类统计图表

1. 添加不同类别的费用（交通、餐饮、住宿、门票等）
2. 查看"分类统计"饼图
3. 验证：
   - ✅ 饼图正确显示各类别占比
   - ✅ 每个扇区颜色与类别对应
   - ✅ 标签显示类别名称和百分比
   - ✅ 鼠标悬停显示详细金额
   - ✅ 图例显示每个类别的名称、笔数和金额

### ✅ 测试 7: 每日趋势图表

1. 添加多条不同日期的费用
2. 查看"每日趋势"柱状图
3. 验证：
   - ✅ 柱状图按日期排序显示
   - ✅ 每个柱子高度代表当天总支出
   - ✅ X 轴显示日期（MM-DD 格式）
   - ✅ Y 轴显示金额
   - ✅ 鼠标悬停显示详细金额

### ✅ 测试 8: 预算进度条和警告

#### 测试预算安全状态（< 80%）

1. 创建预算为 1000 元的计划
2. 添加总计 500 元的费用
3. 验证：
   - ✅ 进度条绿色
   - ✅ 显示 50%
   - ✅ 无警告信息

#### 测试预算警告状态（80-100%）

1. 继续添加费用，使总额达到 850 元
2. 验证：
   - ✅ 进度条黄色
   - ✅ 显示 85%
   - ✅ 显示黄色警告："预算即将用完"

#### 测试预算超支状态（> 100%）

1. 继续添加费用，使总额达到 1100 元
2. 验证：
   - ✅ 进度条红色
   - ✅ 显示 110%
   - ✅ 显示红色警告："已超出预算 ¥100"
   - ✅ 剩余预算显示为负数（红色）

### ✅ 测试 9: 空状态

1. 打开一个没有费用记录的计划
2. 切换到"费用管理"标签页
3. 验证：
   - ✅ 显示空状态占位符
   - ✅ 显示"还没有费用记录"提示
   - ✅ 显示"添加第一笔费用"按钮
   - ✅ 统计卡片显示为 0 或不显示

### ✅ 测试 10: 费用卡片显示

查看费用列表中的卡片，验证：

1. **基本信息**：
   - ✅ 显示类别图标和名称
   - ✅ 显示金额（格式化，带千分位）
   - ✅ 显示日期（格式：MM月dd日 星期X）

2. **描述**：
   - ✅ 如有描述，正确显示
   - ✅ 如无描述，不显示或显示占位符

3. **操作按钮**：
   - ✅ 显示"编辑"按钮
   - ✅ 显示"删除"按钮
   - ✅ 按钮可点击

### ✅ 测试 11: AI 语音解析准确度

测试不同的语音输入格式，验证 AI 解析能力：

| 输入示例 | 预期类别 | 预期金额 | 预期日期 |
|---------|---------|---------|---------|
| "今天午餐花了 68 块" | 餐饮 | 68 | 今天 |
| "打车去机场 120 元" | 交通 | 120 | 今天 |
| "昨天住酒店 350" | 住宿 | 350 | 昨天 |
| "买了熊猫基地门票 120" | 门票 | 120 | 今天 |
| "购物 500" | 购物 | 500 | 今天 |
| "看了场电影 80 块" | 娱乐 | 80 | 今天 |

验证：
- ✅ 金额提取准确（至少 90% 准确率）
- ✅ 类别识别准确（至少 80% 准确率）
- ✅ 日期识别准确（今天/昨天）
- ✅ 如果 AI 无法识别，显示缺失字段提示

### ✅ 测试 12: 多计划隔离

1. 创建两个不同的旅行计划（计划 A 和计划 B）
2. 在计划 A 中添加费用
3. 切换到计划 B，查看费用管理
4. 验证：
   - ✅ 计划 B 不显示计划 A 的费用
   - ✅ 每个计划的费用统计独立
   - ✅ 预算计算独立

### ✅ 测试 13: 响应式设计

在不同屏幕尺寸下测试：

1. **桌面端（> 1024px）**：
   - ✅ 统计卡片 4 列显示
   - ✅ 图表 2 列并排显示

2. **平板端（768px - 1024px）**：
   - ✅ 统计卡片 2 列显示
   - ✅ 图表 1-2 列显示

3. **移动端（< 768px）**：
   - ✅ 统计卡片 1 列堆叠显示
   - ✅ 图表 1 列显示
   - ✅ 费用卡片自适应宽度
   - ✅ 对话框适应屏幕高度（滚动）

### ✅ 测试 14: 错误处理

#### API 错误

1. 断开网络连接
2. 尝试添加费用
3. 验证：
   - ✅ 显示错误提示（Toast）
   - ✅ 用户可以重试
   - ✅ 数据不丢失（在表单中）

#### 语音解析失败

1. 说一些无关内容（如"测试测试"）
2. 尝试解析
3. 验证：
   - ✅ 显示"无法识别"错误
   - ✅ 提示缺失的字段
   - ✅ 允许手动填写

#### 权限错误

1. 尝试访问其他用户的计划费用（通过修改 URL）
2. 验证：
   - ✅ 返回 403 或 404 错误
   - ✅ 不显示其他用户的数据

## 性能测试

### 大量数据测试

1. 添加 50+ 条费用记录
2. 验证：
   - ✅ 列表加载速度 < 1s
   - ✅ 图表渲染流畅
   - ✅ 统计计算准确
   - ✅ 滚动流畅

## 已知问题与限制

1. **语音识别依赖网络**：科大讯飞 API 需要网络连接
2. **AI 解析不保证 100% 准确**：复杂或模糊的语音输入可能需要手动修正
3. **图表在移动端可能较小**：建议横屏查看

## 测试完成检查表

完成测试后，确认以下所有项目：

- [ ] 所有 14 项功能测试通过
- [ ] 在至少 2 种浏览器中测试（Chrome, Firefox, Safari, Edge）
- [ ] 在至少 2 种屏幕尺寸测试（桌面 + 移动）
- [ ] 语音输入功能正常
- [ ] AI 解析准确率可接受
- [ ] 图表显示正确
- [ ] 统计数据准确
- [ ] 预算功能正常
- [ ] 错误处理得当
- [ ] 性能可接受

## 报告问题

如果发现问题，请记录：
1. 问题描述
2. 复现步骤
3. 预期行为
4. 实际行为
5. 浏览器和设备信息
6. 控制台错误（如有）

---

**提示**：建议按顺序完成测试，因为后面的测试可能依赖前面创建的数据。

